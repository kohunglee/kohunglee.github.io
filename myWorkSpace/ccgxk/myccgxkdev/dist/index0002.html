<!-- <!DOCTYPE html> -->
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">
<meta http-equiv="pragma" content="no-cache">
<style>
    body{margin: 0;}
    #posMap {
        position: fixed;
        right: 50px;
        margin-top: -100px;
        opacity: 0.8;
    }
    .myHUD {
        position: absolute;
        bottom: 0;
        padding: 0.3em;
        color: #ffffff;
    }
    #someCtrl {
        position: fixed;
        top: 0;
        opacity: 0.5;
    }
    #someCtrl button {
    width: 45px;
    height: 30px;
}

/* 模态框 */
.myHUD-modal {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100vw;
    height: 100vh;
    transform: translate(-50%, -50%);
}
.myHUD-modalPos {
    margin-left: 50vw;
    margin-top: 50vh;
    transform: translate(-50%, -50%);
    width: 700px;
    text-align: center;
    background-color: rgb(159 51 204 / 55%);
    padding: 32px;
    backdrop-filter: blur(2px);
}

.texture-editorBtn-lab {
    display: inline-block;
    background: rgb(32 32 32);
    color: rgb(255, 255, 255);
    padding: 5px 5px;
    border: none;
    cursor: pointer;
    margin: 5px;
    font-size: 14;
    color: #bbbbbb;
}
canvas {
  /* 针对苹果系统下的火狐和 Chrome/Safari */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
</style>
<!-- <script src="cannon.min.js"></script> -->
<!-- <script src="../src/cannon/cannon-x-dev.js"></script> -->
<!-- <script src="./cannon.js"></script> -->
<script src="../src/cannon/cannon29kb.js"></script>
<img src='./img/texture.jpeg' id=marble hidden>
<canvas id=c style="width:100vw;height:100vh"></canvas>
<div id="myHUD" class="myHUD">
    <div id="fpsInfo"></div>
    <span id="shiftInfo"></span>
    <span id="posInfo"></span>
    <span id="metrics"></span>
    <span id="cpuInfo"></span>
    <span id="modListCount"></span>
    <span id="posIDMVP"></span>
    <canvas id="posMap" width="100" height="100"></canvas>
    <canvas id="centerPoint" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);" width="1" height="1"></canvas>
</div>
<div id="myHUDModal" class="myHUD-modal" hidden>
    <div class="myHUD-modalPos">
        <div>
            左 <input type="number" id="textureEditorOffsetX" name="offsetX" min="0" max="1" step="0.1">
            &nbsp;&nbsp;&nbsp;&nbsp;
            右 <input type="number" id="textureEditorOffsetXR" name="offsetXR" min="0" max="1" step="0.1">
            &nbsp;&nbsp;&nbsp;&nbsp;
            下 <input type="number" id="textureEditorOffsetY" name="offsetY" min="0" max="1" step="0.1">
            （偏移量，0 ~ 1）
        </div>
        <textarea rows="10" cols="50" class="tgeditor-texture" id="textureEditorTG"></textarea>
        <div><br>
            <div>
                <span id="textureEditorInfo"></span><br>
            </div>
            <button class="texture-editorBtn" id="textureEditorSave">写入</button>
            <button class="texture-editorBtn" id="textureEditorCancel">取消</button>
            <button class="texture-editorBtn" id="textureEditorDownload">下载存档</button>
            <label for="textureEditorReadfile" class="texture-editorBtn-lab">读取存档 </label>
            <input  type="file" id="textureEditorReadfile" accept=".json" hidden>
            <div>
                <button class="texture-editorBtn" id="textureEditorClear">清空</button>
                <button class="texture-editorBtn" id="textureEditorNumAux">数字行号辅</button>
                <button class="texture-editorBtn" id="textureEditorNumAuxRemove">一键去除行号</button>
            </div>
            <hr>
            
            <button class="texture-editorBtn" id="textureEditorRcover">从浏览器恢复</button>
        </div>
    </div>
    
</div>
<div id="someCtrl">
    <button id="xforward" style="width: 90px;">前</button>
    <button id="xbackward" style="width: 90px;">城寨入口</button>
    <button id="xright" style="width: 90px;">坐标原点</button>
    <button id="xleft" style="width: 90px;">防眩晕</button>
    <button id="xjump" style="width: 90px;">蹦</button>
    <button id="xShadow" style="width: 90px;">影</button>
    <button id="xVIEW1" style="width: 90px;">视1</button>
    <button id="xStopDY"  style="width: 90px;">小点</button>
    <span id="xVIEW2" style="font-size: 60px;color: rgb(255, 255, 255);position: absolute;left: 50vw;transform: translate(-50%);width: max-content;">城市</span>
</div>
<script>

(()=>{"use strict";var i=[,(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={_hookQueues:new Map,on(t,e,i=100){if("function"!=typeof e)throw new TypeError("Callback must be function");var r=this._hookQueues.get(t)||[];r.push({func:e,priority:i}),r._isSorted=!1,this._hookQueues.set(t,r)},off(t,e){var i,r=this._hookQueues.get(t);r&&(0===(i=r.filter(t=>t.func!==e)).length?this._hookQueues.delete(t):i.length<r.length&&(i._isSorted=!1,this._hookQueues.set(t,i)))},_getSortedCallbacks(t){t=this._hookQueues.get(t);return t?(t._isSorted||(t.sort((t,e)=>e.priority-t.priority),t._isSorted=!0),[...t]):[]},async emit(t,...e){t=this._getSortedCallbacks(t).map(t=>t.func).map(async t=>{try{return await t(...e)}catch(t){throw t}});return Promise.allSettled(t)},emitSync(t,...e){var i,r=[];for({func:i}of this._getSortedCallbacks(t))try{var o=i(...e);if(r.push({status:"fulfilled",value:o}),!1===o)break}catch(t){r.push({status:"rejected",reason:t})}return r}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={quaternionToEuler:function(t){var{x:t,y:e,z:i,w:r}=t,o=Math.atan2(2*(r*t+e*i),1-2*(t*t+e*e)),s=Math.asin(Math.max(-1,Math.min(1,2*(r*e-i*t)))),r=Math.atan2(2*(r*i+t*e),1-2*(e*e+i*i)),t=t=>t*(180/Math.PI);return{rX:t(o),rY:t(s),rZ:t(r)}},genPR:function(t,e){let i=Math.abs(t)||1;i=1664525*i+1013904223|0;var r=new Float32Array(e);for(let t=0;t<e;t++)i=(i=(i^=i<<13)^i>>17)^i<<5,r[t]=(i>>>0)*(1/4294967296);return r},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:.1,restitution:0})}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>c});const x={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:i(1).default,reset:t=>{x.canvas=t,x.objs=0,x.current={},x.next={},x.textures={},x.viewLimit=5e3,x.gl=t.getContext("webgl2"),x.gl.blendFunc(770,771),x.gl.activeTexture(33984),x.program=x.gl.createProgram(),x.gl.enable(2884),x.instanceColorBuffers={},x.lastFrame=0,x.drawTime=0,x.lastReportTime=0,x.gl.shaderSource(t=x.gl.createShader(35633),`#version 300 es
          precision lowp float;                        
          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...
          in mat4 instanceModelMatrix;                  // 实例化模型的 模型
          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵
          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]
          out vec4 v_pos, v_col, v_uv, v_normal;
          uniform bool isInstanced;              // 是不是实例化绘制
          void main() {
            mat4 currentModelMatrix;             // 当前的模型矩阵
            if (isInstanced) {
              currentModelMatrix = instanceModelMatrix;
            } else {
              currentModelMatrix = m;
            }
            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos
              v_pos = bb.z > 0.                         
              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌
              : currentModelMatrix * pos               
            );
            v_col = col;
            v_uv = uv;
            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵
          }`),x.gl.compileShader(t),x.gl.attachShader(x.program,t),x.gl.shaderSource(t=x.gl.createShader(35632),`#version 300 es
          precision lowp float;
          in vec4 v_pos, v_col, v_uv, v_normal;
          uniform vec3 light;
          uniform vec2 tiling;
          uniform vec4 o;
          uniform sampler2D sampler;
          out vec4 c;
          void main() {
            c = mix(texture(sampler, v_uv.xy * tiling), v_col, o[3]);
            if(o[1] > 0.){
              c = vec4(
                c.rgb * (max(0., dot(light, -normalize(
                  o[0] > 0.
                  ? vec3(v_normal.xyz)
                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))
                )))
                + o[2]),
                c.a
              );
            }
          }`),x.gl.compileShader(t),x.gl.attachShader(x.program,t),x.gl.linkProgram(x.program),x.gl.useProgram(x.program),x.clearColor=t=>x.gl.clearColor(...x.col(t)),x.wjsHooks.emitSync("reset_ok",x),x.uniformLocations={pv:x.gl.getUniformLocation(x.program,"pv"),eye:x.gl.getUniformLocation(x.program,"eye"),m:x.gl.getUniformLocation(x.program,"m"),im:x.gl.getUniformLocation(x.program,"im"),bb:x.gl.getUniformLocation(x.program,"bb"),isInstanced:x.gl.getUniformLocation(x.program,"isInstanced"),o:x.gl.getUniformLocation(x.program,"o"),light:x.gl.getUniformLocation(x.program,"light"),tiling:x.gl.getUniformLocation(x.program,"tiling"),sampler:x.gl.getUniformLocation(x.program,"sampler"),u_MvpMatrixFromLight:x.gl.getUniformLocation(x.program,"u_MvpMatrixFromLight"),u_ShadowMap:x.gl.getUniformLocation(x.program,"u_ShadowMap")},x.attribLocations={pos:x.gl.getAttribLocation(x.program,"pos"),col:x.gl.getAttribLocation(x.program,"col"),uv:x.gl.getAttribLocation(x.program,"uv"),normal:x.gl.getAttribLocation(x.program,"normal"),instanceModelMatrix:x.gl.getAttribLocation(x.program,"instanceModelMatrix")},x.clearColor("fff"),x.gl.enable(2929),x.light({y:-1}),x.camera({fov:30}),setTimeout(x.draw,16)},setState:(t,e,i,r,o=0,s,n,a,l,d,u,h,c)=>{if(t.n||="o"+x.objs++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!x.textures[t.t.id]&&(i=x.gl.createTexture(),x.gl.pixelStorei(37441,!0),x.gl.bindTexture(3553,i),x.gl.pixelStorei(37440,1),x.gl.texImage2D(3553,0,6408,6408,5121,t.t),x.gl.generateMipmap(3553),x.textures[t.t.id]=i),t.instances&&Array.isArray(t.instances)){t.isInstanced=!0,t.numInstances=t.instances.length;var m=[],p=[];for(const y of t.instances){var f=new DOMMatrix;f.translateSelf(y.x+(0|t.x)|0,y.y+(0|t.y)|0,y.z+(0|t.z)|0).rotateSelf(y.rx||0,y.ry||0,y.rz||0).scaleSelf(y.w||1,y.h||1,y.d||1),m.push(...f.toFloat32Array())}for(const v of t.instances)p.push(...x.col(v.b||"888"));var i=new Float32Array(m),g=x.gl.createBuffer();x.gl.bindBuffer(x.gl.ARRAY_BUFFER,g),x.gl.bufferData(x.gl.ARRAY_BUFFER,i,x.gl.STATIC_DRAW),x.instanceMatrixBuffers[t.n]=g,x.gl.bindBuffer(x.gl.ARRAY_BUFFER,x.instanceColorBuffers[t.n]=x.gl.createBuffer()),x.gl.bufferData(x.gl.ARRAY_BUFFER,new Float32Array(p),x.gl.STATIC_DRAW),t.instances=null}else t.isInstanced=!1;t.fov&&(i=x.viewLimit,x.projection=new DOMMatrix([1/Math.tan(t.fov*Math.PI/180)/(x.canvas.width/x.canvas.height),0,0,0,0,1/Math.tan(t.fov*Math.PI/180),0,0,0,0,-(i+.1)/(i-.1),-1,0,0,-2*i*.1/(i-.1),0])),t={type:e,...x.current[t.n]=x.next[t.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...t,f:0},x.models[t.type]?.vertices&&!x.models?.[t.type].verticesBuffer&&(x.gl.bindBuffer(34962,x.models[t.type].verticesBuffer=x.gl.createBuffer()),x.gl.bufferData(34962,new Float32Array(x.models[t.type].vertices),35044),!x.models[t.type].normals&&x.smooth&&x.smooth(t),x.models[t.type].normals)&&(x.gl.bindBuffer(34962,x.models[t.type].normalsBuffer=x.gl.createBuffer()),x.gl.bufferData(34962,new Float32Array(x.models[t.type].normals.flat()),35044)),x.models[t.type]?.uv&&!x.models[t.type].uvBuffer&&(x.gl.bindBuffer(34962,x.models[t.type].uvBuffer=x.gl.createBuffer()),x.gl.bufferData(34962,new Float32Array(x.models[t.type].uv),35044)),x.models[t.type]?.indices&&!x.models[t.type].indicesBuffer&&(x.gl.bindBuffer(34963,x.models[t.type].indicesBuffer=x.gl.createBuffer()),x.gl.bufferData(34963,new Uint16Array(x.models[t.type].indices),35044)),t.t?t.mix||(t.mix=0):t.mix=1,x.next[t.n]=t},draw:(t,e,i,r,o=[])=>{var s=performance.now();if(e=t-x.lastFrame,x.lastFrame=t,requestAnimationFrame(x.draw),x.debugFBO)renderFBOToCanvas();else{for(r in x.next.camera.g&&x.render(x.next[x.next.camera.g],e,1),i=x.animation("camera"),x.next?.camera?.g&&i.preMultiplySelf(x.next[x.next.camera.g].M||x.next[x.next.camera.g].m),x.gl.uniformMatrix4fv(x.uniformLocations.eye,!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(x.projection),x.gl.uniformMatrix4fv(x.uniformLocations.pv,!1,i.toFloat32Array()),x.wjsHooks.emitSync("shadow_draw",x),x.gl.clear(16640),x.next){var n=x.next[r];n.isInstanced||n.t||1!=x.col(n.b)[3]?o.push(n):x.render(n,e)}o.sort((t,e)=>x.dist(e)-x.dist(t)),x.gl.enable(3042),x.gl.depthMask(1);for(r of o)r.isInstanced&&x.render(r,e);for(r of o)r.isInstanced||x.render(r,e);x.gl.depthMask(1),x.gl.disable(3042),x.gl.uniform3f(x.uniformLocations.light,x.lerp("light","x"),x.lerp("light","y"),x.lerp("light","z")),1e3<=t-x.lastReportTime&&(x.drawTime=(performance.now()-s).toFixed(2)+"ms",x.lastReportTime=t)}},render:(t,e,i=["camera","light","group"].includes(t.type),r)=>{if(t.t&&(x.gl.activeTexture(x.gl.TEXTURE0),x.gl.bindTexture(3553,x.textures[t.t.id]),x.gl.uniform1i(x.uniformLocations.sampler,0),x.gl.uniform2f(x.uniformLocations.tiling,t.tile?.[0]||1,t.tile?.[1]||1)),t.isInstanced||(t.f<t.a&&(t.f+=e),t.a<t.f&&(t.f=t.a),x.next[t.n].m=x.animation(t.n),x.next[t.g]&&x.next[t.n].m.preMultiplySelf(x.next[t.g].M||x.next[t.g].m),i)||(x.gl.uniformMatrix4fv(x.uniformLocations.m,!1,(x.next[t.n].M||x.next[t.n].m).toFloat32Array()),x.gl.uniformMatrix4fv(x.uniformLocations.im,!1,new DOMMatrix(x.next[t.n].M||x.next[t.n].m).invertSelf().toFloat32Array())),!i){if(x.gl.bindBuffer(34962,x.models[t.type].verticesBuffer),x.gl.vertexAttribPointer(r=x.attribLocations.pos,3,5126,!1,0,0),x.gl.enableVertexAttribArray(r),x.gl.vertexAttribDivisor(r,0),x.models[t.type].uvBuffer&&(x.gl.bindBuffer(34962,x.models[t.type].uvBuffer),x.gl.vertexAttribPointer(r=x.attribLocations.uv,2,5126,!1,0,0),x.gl.enableVertexAttribArray(r),x.gl.vertexAttribDivisor(r,0)),(t.s||x.models[t.type].customNormals)&&x.models[t.type].normalsBuffer&&(x.gl.bindBuffer(34962,x.models[t.type].normalsBuffer),x.gl.vertexAttribPointer(r=x.attribLocations.normal,3,5126,!1,0,0),x.gl.enableVertexAttribArray(r),x.gl.vertexAttribDivisor(r,0)),x.gl.uniform1i(x.uniformLocations.isInstanced,t.isInstanced?1:0),t.isInstanced&&x.instanceMatrixBuffers[t.n]){var e=x.instanceMatrixBuffers[t.n],o=(x.gl.bindBuffer(x.gl.ARRAY_BUFFER,e),x.attribLocations.instanceModelMatrix),s=16*Float32Array.BYTES_PER_ELEMENT;for(let t=0;t<4;++t){var n=o+t;x.gl.enableVertexAttribArray(n),x.gl.vertexAttribPointer(n,4,x.gl.FLOAT,!1,s,4*t*Float32Array.BYTES_PER_ELEMENT),x.gl.vertexAttribDivisor(n,1)}}x.gl.uniform4f(x.uniformLocations.o,t.s,(3<t.mode||3<x.gl[t.mode])&&!t.ns?1:0,x.ambientLight||.2,t.mix),x.gl.uniform4f(x.uniformLocations.bb,t.w,t.h,"billboard"==t.type,0);i=x.attribLocations.col;if(t.isInstanced?(x.gl.enableVertexAttribArray(i),x.gl.bindBuffer(x.gl.ARRAY_BUFFER,x.instanceColorBuffers[t.n]),x.gl.vertexAttribPointer(i,4,x.gl.FLOAT,!1,0,0),x.gl.vertexAttribDivisor(i,1)):x.gl.vertexAttrib4fv(i,x.col(t.b||"888")),x.models[t.type].indicesBuffer?(x.gl.bindBuffer(34963,x.models[t.type].indicesBuffer),t.isInstanced?x.gl.drawElementsInstanced(+t.mode||x.gl[t.mode],x.models[t.type].indices.length,x.gl.UNSIGNED_SHORT,0,t.numInstances):x.gl.drawElements(+t.mode||x.gl[t.mode],x.models[t.type].indices.length,5123,0)):t.isInstanced?x.gl.drawArraysInstanced(+t.mode||x.gl[t.mode],0,x.models[t.type].vertices.length/3,t.numInstances):x.gl.drawArrays(+t.mode||x.gl[t.mode],0,x.models[t.type].vertices.length/3),t.isInstanced){var a=x.attribLocations.instanceModelMatrix;for(let t=0;t<4;++t)x.gl.vertexAttribDivisor(a+t,0),x.gl.disableVertexAttribArray(a+t);x.gl.vertexAttribDivisor(i,0),x.gl.disableVertexAttribArray(i)}}},lerp:(t,e)=>x.next[t]?.a?x.current[t][e]+(x.next[t][e]-x.current[t][e])*(x.next[t].f/x.next[t].a):x.next[t][e],animation:(t,e=new DOMMatrix)=>x.next[t]?e.translateSelf(x.lerp(t,"x"),x.lerp(t,"y"),x.lerp(t,"z")).rotateSelf(x.lerp(t,"rx"),x.lerp(t,"ry"),x.lerp(t,"rz")).scaleSelf(x.lerp(t,"w"),x.lerp(t,"h"),x.lerp(t,"d")):e,dist:(t,e=x.next.camera)=>t?.m&&e?.m?(e.m.m41-t.m.m41)**2+(e.m.m42-t.m.m42)**2+(e.m.m43-t.m.m43)**2:0,ambient:t=>x.ambientLight=t,col:e=>[...e.replace("#","").match(e.length<5?/./g:/../g).map(t=>("0x"+t)/(e.length<5?15:255)),1],add:(e,t)=>{(x.models[e]=t).normals&&(x.models[e].customNormals=1),x[e]=t=>x.setState(t,e)},resetView:()=>{x.gl.viewport(0,0,x.gl.canvas.width,x.gl.canvas.height),x.setState({n:"camera",fov:x.next.camera.fov})},group:t=>x.setState(t,"group"),move:(t,e)=>setTimeout(()=>{x.setState(t)},e||1),delete:(t,e)=>setTimeout(()=>{delete x.next[t]},e||1),camera:(t,e)=>setTimeout(()=>{x.setState(t,t.n="camera")},e||1),light:(t,e)=>e?setTimeout(()=>{x.setState(t,t.n="light")},e):x.setState(t,t.n="light"),smooth:(t,e={},i=[],r,o,s,n,a,l,d,u,h,c,m)=>{for(x.models[t.type].normals=[],s=0;s<x.models[t.type].vertices.length;s+=3)i.push(x.models[t.type].vertices.slice(s,s+3));for(o=(r=x.models[t.type].indices)?1:(r=i,0),s=0;s<2*r.length;s+=3){n=s%r.length,a=i[u=o?x.models[t.type].indices[n]:n],l=i[h=o?x.models[t.type].indices[1+n]:1+n],d=i[c=o?x.models[t.type].indices[2+n]:2+n];var p=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],f=[d[0]-l[0],d[1]-l[1],d[2]-l[2]];m=n<s?[0,0,0]:[p[1]*f[2]-p[2]*f[1],p[2]*f[0]-p[0]*f[2],p[0]*f[1]-p[1]*f[0]],e[a[0]+"_"+a[1]+"_"+a[2]]||=[0,0,0],e[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],e[d[0]+"_"+d[1]+"_"+d[2]]||=[0,0,0],x.models[t.type].normals[u]=e[a[0]+"_"+a[1]+"_"+a[2]]=e[a[0]+"_"+a[1]+"_"+a[2]].map((t,e)=>t+m[e]),x.models[t.type].normals[h]=e[l[0]+"_"+l[1]+"_"+l[2]]=e[l[0]+"_"+l[1]+"_"+l[2]].map((t,e)=>t+m[e]),x.models[t.type].normals[c]=e[d[0]+"_"+d[1]+"_"+d[2]]=e[d[0]+"_"+d[1]+"_"+d[2]].map((t,e)=>t+m[e])}}};x.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),x.add("billboard",x.models.plane),x.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]}),x.cube=t=>x.setState(t,"cube"),x.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]});var[r,o,s,n,a,l,d=[],u=[],h=[]]=[];for(s=0;s<=20;s++)for(n=s*Math.PI/20,r=0;r<=20;r++)o=2*r*Math.PI/20,d.push(+(Math.sin(o)*Math.sin(n)/2).toFixed(6),+(Math.cos(n)/2).toFixed(6),+(Math.cos(o)*Math.sin(n)/2).toFixed(6)),h.push(3.5*Math.sin(r/20),-Math.sin(s/20)),r<20&&s<20&&u.push(a=21*s+r,l=a+21,a+1,a+1,l,l+1);x.add("sphere",{vertices:d,uv:h,indices:u});const c=x},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={speedH:3,speedL:8,speedAdd:.1,jumpYVel:5,fov:35,colorClear:"#7A4141",world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(t){this.canvas=window.document.getElementById(t),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animate(),shiftInfo.textContent="速度:0 | "},initW:function(t){var e=this.W;t.width=+window.innerWidth,t.height=+window.innerHeight,e.reset(t),e.ambient(.7),e.light({x:.5,y:-.3,z:.5}),e.clearColor(this.colorClear),e.camera({n:"camera",fov:this.fov}),e.group({n:"posZero",x:0,y:1,z:0}),e.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),e.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),e.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),e.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),e.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),e.pyramid({g:"posZero",n:"test0001",size:1,z:10,rx:90,b:"44f"}),e.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={textureMap:new Map,loadTextureIndex:1,loadTexture:function(o){return new Promise(t=>{for(var e=!0,i=0;i<o.length;i++)if(!1===this.textureMap.has(o[i].id)){e=!1;const r=new Image;r.onload=()=>t(r),r.id=o[i].id+"-"+this.loadTextureIndex,r.src=this.dToBase64(o[i]),this.textureMap.set(o[i].id,r),this.loadTextureIndex++}e&&t(null)})},canvasObj:document.createElement("canvas"),dToBase64:function(t){var e=this.canvasObj,i=(e.width=t.width||400,e.height=t.height||400,e.getContext("2d"));return"png"===t.type?(t.func(i,e.width,e.height,t,this),e.toDataURL("image/png")):(i.fillStyle="white",i.fillRect(0,0,e.width,e.height),t.func(i,e.width,e.height,t,this),i=t.quality||.7,e.toDataURL("image/jpeg",i))},errorTexture:function(t,e,i,r,o){o.hooks.emitSync("errorTexture_diy",t,e,i,r,o)}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"turnLeft",arrowright:"turnRight"},isShiftPress:0,antiDizzyMode:!1,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var e=this,i=!1;document.addEventListener("keydown",function(t){e._handleKey(t,1)}),document.addEventListener("keyup",function(t){e._handleKey(t,0)}),document.addEventListener("mousemove",function(t){i&&(e.keys.turnRight-=.1*t.movementX,e.keys.turnUp-=.1*t.movementY)}),this.canvas.addEventListener("click",t=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),i=!0,document.pointerLockElement&&e.hooks.emitSync("pointer_lock_click",e,t)}),this.lockChangeAlert=function(){i=document.pointerLockElement===e.canvas||document.mozPointerLockElement===e.canvas||document.webkitPointerLockElement===e.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()})},_handleKey:function(t,e){var i;this.isPointerLock()&&((i=this.keyMap[t.key.toLowerCase()])&&(this.keys[i]=e),32!==t.keyCode&&"e"!==t.key.toLowerCase()||null===this.mainVPlayer||(i=this.mainVPlayer.body.position.y<=1e4,0===this.keys.jumping&&i&&(this.mainVPlayer.body.velocity.y=this.jumpYVel),this.keys.jumping=e),16!==t.keyCode&&"q"!==t.key.toLowerCase()||(this.isShiftPress=e))},forwardAcc:0,displayPOS:function(){var t=document.getElementById("posInfo");null!==this.mainVPlayer&&(t.textContent="位置: X:"+this.mainVPlayer.body.position.x.toFixed(2)+", Y:"+this.mainVPlayer.body.position.y.toFixed(2)+", Z:"+this.mainVPlayer.body.position.z.toFixed(2)+", | ")},calMovePara:function(t,e,i,r,o,s){var n,a=this.keys;return(a.viewForward||a.viewBackward)&&(n=this.isShiftPress?Math.max(this.speedH,this.speedL-(this.forwardAcc+=this.speedAdd)):this.speedL+0*(this.forwardAcc=.01),shiftInfo.textContent="速度:"+Math.round(100/n)+" | ",i+=(-a.viewForward+a.viewBackward)*Math.cos(o*Math.PI/180)/n,t+=(-a.viewForward+a.viewBackward)*Math.sin(o*Math.PI/180)/n,this.displayPOS()),(a.viewLeft||a.viewRight)&&(i+=(-a.viewLeft+a.viewRight)*Math.cos((o+90)*Math.PI/180)/10,t+=(-a.viewLeft+a.viewRight)*Math.sin((o+90)*Math.PI/180)/10,this.displayPOS()),o=this.keys.turnRight,{x:t,y:e=a.viewUp||a.viewDown?150:e,z:i,rx:this.keys.turnUp,ry:o,rz:s}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(t){var e,i,r;if(null!==t)return r=this.mainCamera,!1===this.isMVPInit&&(r.groupName=t.name,this.isMVPInit=!0),i=t.body.position,e=t.body.quaternion,i=this.calMovePara(i.x,i.y,i.z,r.qua.rx,r.qua.ry,r.qua.rz),t.body.position.x=i.x,t.body.position.y=i.y,t.body.position.z=i.z,r.qua=i,e.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*i.ry),this.W.camera({g:t.name,x:r.pos.x,y:r.pos.y,z:r.pos.z,rx:r.qua.rx,rz:r.qua.rz}),e=t.body.position,i=t.body.quaternion,r=this.quaternionToEuler(i),t.quat=i,t.rX=r.rX,t.rY=r.rY,t.rZ=r.rZ,t.X=e.x,t.Y=e.y,t.Z=e.z,this.W.move({n:t.name,x:t.X,y:t.Y,z:t.Z,rx:t.rX,ry:t.rY,rz:t.rZ}),t.posID=this.calPosID(t.X,t.Y,t.Z,2),0}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={calPosID:function(t,e,i,r){var o,s,n={2:100,3:100,4:40}[r]||0;return 2===r&&(r=""),0===n?0:(o=-1===Math.sign(t)?"X":"D",s=-1===Math.sign(i)?"B":"N",r+o+Math.ceil(t/n*Math.sign(t))+s+Math.ceil(i/n*Math.sign(i)))},gridsize:new Uint16Array([1e4,1e3,100,20]),currentlyActiveIndices:new Set,activationQueue:new Array,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";var t=this.mainVPlayer,r=[];for(let i=0;i<this.gridsize.length;i++){var o=Math.floor(t.X/this.gridsize[i]),s=Math.floor(t.Z/this.gridsize[i]);for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)r.push(`${i}_${o+e}_`+(s+t))}var e,i=new Set,n=new Set(this.currentlyActiveIndices);for(const d of r){var a=this.spatialGrid.get(d);if(a)for(const u of a)Math.abs(this.positionsStatus[8*u+1]-t.Y)<this.gridsize[this.physicsProps[8*u+4]]&&i.add(u)}for(const h of i)n.delete(h);for(const c of i)this.currentlyActiveIndices.has(c)||(e=8*c,this.positionsStatus[7+e]=this.physicsProps[e],this.activeTABox(c));for(const m of n){var l=8*m;this.positionsStatus[7+l]=-1,this.hiddenTABox(m)}this.currentlyActiveIndices=i,0<this.activationQueue.length&&!this.isActivationScheduled&&(this.isActivationScheduled=!0,requestIdleCallback(this._processActivationQueue.bind(this)))}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(i=1e6){this.positionsStatus=new Float32Array(8*i),this.physicsProps=new Float32Array(8*i),this.freeSlots=new Array(i).fill(0).map((t,e)=>i-1-e)},addTABox:function({DPZ:t=3,X:e=5,Y:i=5,Z:r=5,quat:o={x:0,y:0,z:0,w:1},mass:s=0,width:n=1,depth:a=1,height:l=1,size:d=1}={}){var u=Array.from(arguments)[0];if(1!==d&&(n=a=l=d),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;var d=this.freeSlots.pop(),h=8*d,i=(this.positionsStatus[h]=e,this.positionsStatus[1+h]=i,this.positionsStatus[2+h]=r,this.positionsStatus[3+h]=o.x,this.positionsStatus[4+h]=o.y,this.positionsStatus[5+h]=o.z,this.positionsStatus[6+h]=o.w,this.positionsStatus[7+h]=s,this.physicsProps[h]=s,this.physicsProps[1+h]=n,this.physicsProps[2+h]=l,this.physicsProps[3+h]=a,`${this.physicsProps[4+h]=t}_${Math.floor(e/this.gridsize[t])}_`+Math.floor(r/this.gridsize[t]));let c=this.spatialGrid.get(i);(c=c||[]).push(d),this.spatialGrid.set(i,c),this.indexToArgs.set(d,u)},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1},activeTABox:function(e){var t,i,r,o=8*e,s=this.positionsStatus.subarray(o,8+o),o=this.physicsProps.subarray(o,4+o),n=this.indexToArgs.get(e);const a={...this.defaultBoxArgs,...n};a.isPhysical&&((i=new CANNON.Body).mass=o[0],i.type=0===o[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,t="sphere"===a.shape?new CANNON.Sphere(o[1]/2):(t=new CANNON.Vec3(o[1]/2,o[2]/2,o[3]/2),new CANNON.Box(t)),i.addShape(t),i.position.set(s[0],s[1],s[2]),i.material=this.cannonDefaultContactMaterial,i.updateMassProperties(),i.wakeUp(),i.collisionFilterGroup=a.colliGroup,t={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum},i.collisionFilterMask=t[a.colliGroup],this.world.addBody(i),i.quaternion.set(s[3],s[4],s[5],s[6]),n.cannonBody=i),!1!==a.isVisualMode&&(t=a.tiling,0!==s[3]&&(n=this.quaternionToEuler({x:s[3],y:s[4],z:s[5],w:s[6]}),a.rX=n.x,a.rY=n.y,a.rZ=n.z),"number"==typeof t&&(t=[t,t]),i=a.isFictBody?.1:0,n=!1,"string"==typeof a.texture?void 0!==window[a.texture]||this.textureMap.has(a.texture)?r=this.textureMap.has(a.texture)?this.textureMap.get(a.texture):window[a.texture]:n=!(r=null):r=a.texture,this.W[a.shape]({n:"T"+e,w:o[1]-i,d:o[3]-i,h:o[2]-i,x:s[0],y:s[1],z:s[2],t:r,s:a.smooth,tile:t,rx:a.rX,ry:a.rY,rz:a.rZ,b:a.background,mix:a.mixValue,shadow:a.isShadow}),n)&&(s=40*(o[1]-i),r=40*(o[2]-i),this.loadTexture([{func:this.errorTexture,id:a.texture,type:"png",width:s,height:r,index:e}]).then(t=>{this.W[a.shape]({n:"T"+e,t:this.textureMap.get(a.texture),mix:a.mixValue})}))},hiddenTABox:function(t){var e=this.indexToArgs.get(t);!1!==e.isPhysical&&void 0!==e.cannonBody&&this.world.removeBody(e.cannonBody),!1!==e.isVisualMode&&this.W.delete("T"+t)},addBox:function({DPZ:t=2,isPhysical:e=!0,isVisualMode:i=!0,colliGroup:r=2,name:o="k"+this.bodyObjName++,X:s=5,Y:n=5,Z:a=5,quat:l=null,isShadow:d=0,tiling:u=[1,1],shape:h="cube",mass:c=0,width:m=1,depth:p=1,height:f=1,size:g=1,texture:y=null,smooth:v=0,background:x="#888",mixValue:w=.71,rX:b=0,rY:M=0,rZ:A=0}={}){var S,P=Array.from(arguments),B=this.calPosID(s,n,a,t),g=(1!==g&&(m=p=f=g),null),_=(e&&(S="sphere"===h?new CANNON.Sphere(m/2):(S=new CANNON.Vec3(m/2,f/2,p/2),new CANNON.Box(S)),(g=new CANNON.Body({mass:c,shape:S,position:new CANNON.Vec3(s,n,a),material:this.cannonDefaultCantactMaterial})).collisionFilterGroup=r,S={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum},g.collisionFilterMask=S[r],this.world.addBody(g),l&&g.quaternion.set(l.x,l.y,l.z,l.w),l=g.quaternion),i&&this.W[h]({n:o,w:m,d:p,h:f,x:s,y:n,z:a,t:y,s:v,tile:u="number"==typeof u?[u,u]:u,rx:b,ry:M,rz:A,b:x,mix:w,shadow:d}),{name:o,body:g,X:s,Y:n,Z:a,rX:b,rY:M,rZ:A,isVisualMode:i,myargs:P,posID:B,DPZ:t,quat:l});switch(!0){case!1===e:this.bodylistNotPys.push(_);break;case 0===c:this.bodylistMass0.push(_);break;default:this.bodylist.push(_)}return _}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const r={gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const n of this.currentlyActiveIndices){var t,e,i,r,o,s=8*n;0<this.positionsStatus[7+s]&&(o=(t=this.indexToArgs.get(n)).cannonBody)&&(r=o.position.x-this.positionsStatus[s],i=o.position.y-this.positionsStatus[1+s],e=o.position.z-this.positionsStatus[2+s],r=Math.sqrt(r*r+i*i+e*e),this.positionsStatus[s]=o.position.x,this.positionsStatus[1+s]=o.position.y,this.positionsStatus[2+s]=o.position.z,this.positionsStatus[3+s]=o.quaternion.x,this.positionsStatus[4+s]=o.quaternion.y,this.positionsStatus[5+s]=o.quaternion.z,this.positionsStatus[6+s]=o.quaternion.w,!1!==t.isVisualMode)&&this.W.next["T"+n]&&1e-4<r&&(i=this.quaternionToEuler(o.quaternion),this.W.move({n:"T"+n,x:this.positionsStatus[s],y:this.positionsStatus[1+s],z:this.positionsStatus[2+s],rx:i.rX,ry:i.rY,rz:i.rZ}),.01<r)&&500<performance.now()-this.gridKeyCurrentTime&&(e=t.gridkey||0,i=`${o=this.physicsProps[4+s]}_${Math.floor(this.positionsStatus[s]/this.gridsize[o])}_`+Math.floor(this.positionsStatus[2+s]/this.gridsize[o]),e&&i!==e&&((r=this.spatialGrid.get(e))&&-1<(s=r.indexOf(n))&&(r.splice(s,1),this.spatialGrid.set(e,r)),(o=(o=this.spatialGrid.get(i))||[]).push(n),this.spatialGrid.set(i,o)),t.gridkey=i,this.gridKeyCurrentTime=performance.now())}},cannonAni:function(){this.world.step(1/60)},fpsFrameCount:0,lastTime:performance.now(),isFirstShowFPS:!0,showFPS1S:function(){var t=performance.now(),e=t-this.lastTime;this.fpsFrameCount++,(1e3<e||this.isFirstShowFPS)&&(this.isFirstShowFPS=!1,e=this.fpsFrameCount/(e/1e3),this.fpsFrameCount=0,this.lastTime=t,this._showMemory(),this.displayPOS(),t=this.mainVPlayer,t=this.calPosID(t?.X,t?.Y,t?.Z,2),posIDMVP.textContent=t.replace(/[Dd]/g,"东").replace(/[Xx]/g,"西").replace(/[Nn]/g,"南").replace(/[Bb]/g,"北"),fpsInfo.textContent="FPS："+e.toFixed(1)+"  ，渲染："+this.W.drawTime,modListCount.textContent="当前模型数："+this.bodylist.length+" - ❀"+this.bodylistNotPys.length+" - 口"+this.bodylistMass0.length+" - ⚡️ "+this.currentlyActiveIndices.size+`（can ${this.world.bodies.length}）`+`（${this.indexToArgs.size}）`+`（纹理：${this.textureMap.size}）`+" |")},_showMemory:function(){var t=document.getElementById("metrics");performance.memory&&(t.textContent=`内存: ${((t=performance.memory).usedJSHeapSize/1048576).toFixed(1)}MB/`+(t.jsHeapSizeLimit/1048576).toFixed(1)+"MB | ")},animate:function(){var t=this;function e(){t.showFPS1S(),t.cannonAni(),t.updataBodylist(),t.mainVPlayerMove(t.mainVPlayer),requestAnimationFrame(e)}e()}}}],r={};function o(t){var e=r[t];return void 0!==e||(e=r[t]={exports:{}},i[t](e,e.exports,o)),e.exports}o.d=(t,e)=>{for(var i in e)o.o(e,i)&&!o.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var t={};{o.r(t),o.d(t,{default:()=>c});var t=o(1),e=o(2),s=o(3),n=o(4),a=o(5),l=o(6),d=o(7),u=o(8),h=o(9),t={hooks:t.default,W:s.default,...e.default,...n.default,...a.default,...l.default,...d.default,...u.default,...h.default};const c=window.ccgxk=t}})();

</script>


<script>
var k = ccgxk;  // 初始化沙盒
k.initWorld('c');
var list = k.bodylist;


// k.W.isOpenShadow = !k.W.isOpenShadow;  // 关闭阴影

// 定义单个立方体对象的多个实例
const cubeInstances = [];
var cubeTimes = 1;
var numCubes = 100 * cubeTimes;
const spacing = 2.5;
const areaSpace = 10**1;
const random = k.genPR(17, numCubes * numCubes * 5);  // 伪随机数
for (let i = 0; i < numCubes; i++) {
    for (let j = 0; j < numCubes; j++) {
        var index = i * numCubes + j;
        cubeInstances.push({
            x: Math.floor(random[index] * 99 * areaSpace + 1 - 50 * areaSpace) * cubeTimes,
            y: Math.floor(random[index + 1] * 50),
            z: Math.floor(random[index + 2] * 99 * areaSpace + 1 - 50 * areaSpace) * cubeTimes,
            w: 20,
            d: 30,
            h: Math.floor(random[index + 3] * 19 + 1),
            b:`#${Math.floor(random[index + 4] * 16777216).toString(16).padStart(6, '0')}`,
        });
    }
}

// 实例化物体可视化
for (let index = 0; index < 1; index++) {
  k.W.cube({
    n: 'manyCubes' + index,
    instances: cubeInstances, // 实例属性的数组
    t: marble,
    mix: 0.5,
    y:50 * index * 10,
  });
}

// 为实例化加上简单的物理引擎
for (let i = 0; i < numCubes; i++) {
    for (let j = 0; j < numCubes; j++) {
        var index = i * numCubes + j;
        k.addTABox({
            DPZ : 3,
            isPhysical: true,
            X: Math.floor(random[index] * 99 * areaSpace + 1 - 50 * areaSpace) * cubeTimes,
            Y: Math.floor(random[index + 1] * 50),
            Z: Math.floor(random[index + 2] * 99 * areaSpace + 1 - 50 * areaSpace) * cubeTimes,
            mass: 0,
            width: 20,
            depth: 30,
            height: Math.floor(random[index + 3] * 19 + 1),
            background: `#${Math.floor(random[index + 4] * 16777216).toString(16).padStart(6, '0')}`,
            mixValue: 1,
            isShadow: false,
            isVisualMode: false,
            isFictBody: true,
            texture: marble,
        });
    }
}


// 测试创造一个文字纹理和物体绑定
k.currTextData = new Map();
function makeTestObj(indexObj = 8074){
    const expRatio = 40;
    const indexOfArr = indexObj * 8;
    const objWidth  = k.physicsProps[indexOfArr + 1];  // 这样排列写，性能好一点
    const objHeight = k.physicsProps[indexOfArr + 2];
    const objDepth  = k.physicsProps[indexOfArr + 3];
    const objPosX = k.positionsStatus[indexOfArr];
    const objPosY = k.positionsStatus[indexOfArr + 1];
    const objPosZ = k.positionsStatus[indexOfArr + 2];
    const cWidth = objWidth * expRatio;
    const cHeight = objHeight * expRatio;
    const imgID = 'T' + indexObj + 'N';
    const nudge = 0.1;  // 空隙

    const faceConfigs = [  // { 名字, 位置偏移, 旋转角度, 尺寸 }
        { name: '_forward', X: objPosX, Y: objPosY, Z: objPosZ + objDepth / 2 + nudge, rX: 0,   rY: 0,   width: objWidth, height: objHeight },
        { name: '_backward', X: objPosX, Y: objPosY, Z: objPosZ - objDepth / 2 - nudge, rX: 0,   rY: 180, width: objWidth, height: objHeight },
        { name: '_top', X: objPosX, Y: objPosY + objHeight / 2 + nudge, Z: objPosZ, rX: -90,  rY: 0,   width: objWidth, height: objDepth},
        { name: '_down', X: objPosX, Y: objPosY - objHeight / 2 - nudge, Z: objPosZ, rX: 90,   rY: 0,   width: objWidth, height: objDepth },
        { name: '_right', X: objPosX + objWidth / 2 + nudge, Y: objPosY, Z: objPosZ, rX: 0,   rY: 90,  width: objDepth, height: objHeight },
        { name: '_left', X: objPosX - objWidth / 2 - nudge, Y: objPosY, Z: objPosZ, rX: 0,   rY: -90,   width: objDepth, height: objHeight },
    ];

    faceConfigs.forEach(face => {
            k.addTABox({  // 创建一个 TA 平面试试
            DPZ : 3,
            shape: 'plane',
            isPhysical: false,
            // isVisualMode: false,
            X: face.X, Y: face.Y, Z: face.Z, rX: face.rX, rY: face.rY, rZ: 0,
            mass: 0, width: face.width, depth: 0, height: face.height,
            texture: null, 
            background:'#00000000', mixValue: 0,  // 设置成透明，防止闪烁
            TGtoolText: true,  // 贴逛使用的参数，如果为 true，则表示可以编辑纹理（文字）
        });
    })
    
}


// 向内存里添加 plane 文字板物体
let currentIndex_obj = 0;
const totalTasks = 10000;
function addPlaneObj2Memory(deadline) {  // 添加物体
    while (deadline.timeRemaining() > 0 && currentIndex_obj < totalTasks) {
        makeTestObj(currentIndex_obj);  // 执行任务
        currentIndex_obj++;
    }
    if (currentIndex_obj < totalTasks) {
        requestIdleCallback(addPlaneObj2Memory);
    } else {
        console.log("所有 add obj 步已优雅地完成！");
    }
    if(currentIndex_obj % 100 === 0){  // 显示进度
        xforward.innerHTML = 'obj ' + currentIndex_obj;
    }
}
if(window.requestIdleCallback === undefined){  // safari bug
    for (let i = 0; i < totalTasks; i++) {
        makeTestObj(i);
    }
} else {
    requestIdleCallback(addPlaneObj2Memory);
}





// 利用钩子来自定义纹理
k.hooks.on('errorTexture_diy', function(ctx, width, height, drawItem, _this){
    const index = drawItem.index;
    const id = drawItem.id;
    if('T' + index !== id) return;  // 只支持 T1234 这种格式的图片名
    const value = k.currTextData.get(id)?.content || '';  //+3 使用文字库 currTextData 里的文字，偏移量
    const offsetX = k.currTextData.get(id)?.x || 0;
    const offsetY = k.currTextData.get(id)?.y || 0;
    const offsetXR = k.currTextData.get(id)?.xr || 0;
    const typeObj = {};
    ctx.font = typeObj.font || "25px Arial";                  // 字体大小和类型
    ctx.fillStyle =  typeObj.fillStyle || "white";            // 填充颜色
    ctx.strokeStyle = 'transparent';                          // 好像没用（描边颜色）
    ctx.textAlign =  typeObj.textAlign || "left";             // 水平对齐方式（left/center/right）

    ctx.textBaseline =  typeObj.textBaseline ||"top";         // 垂直对齐方式（top/middle/bottom）
    var lineHeight = parseInt(ctx.font) || 30;
    const margin = 10;  // 边距
    const marginLeft = 10;  // 边距
    const marginTop = 10;
    ctx.clearRect(0, 0, width, height);  // 透明色
    ctx.fillStyle = 'white';
    
    // 简单排版函数
    function wrapText(_ctx, text, x, y, maxWidth, lineHeight) {
        text = text.split('/*')[0];  // 去掉注释
        const words = text.split(''); // 按单个字符来拆分，保证中英文都能换行
        let line = ''; // 当前正在排版的行内容
        for(let n = 0; n < words.length; n++) {
            if (words[n] === '\n') {  //+ 处理 \n 来换行的逻辑
                _ctx.fillText(line, x, y);
                y += lineHeight; line = '';
                continue;
            }
            if(words[n] === '&'){  // 本行内有 &, 则本行颜色为透明
                ctx.fillStyle = 'transparent';
                ctx.font = "25px Arial";
                lineHeight = 25;
                words[n] = '';
            }
            if(words[n] === '#'){  // 本行内有 @, 则本行颜色为蓝色
                ctx.fillStyle = 'blue';
                ctx.font = "40px serif";
                lineHeight = 43;
                words[n] = '';
            }
            if(words[n] === '%'){  // 本行内有 @, 则本行颜色为红色
                ctx.fillStyle = 'red';  
                ctx.font = "40px serif";
                lineHeight = 43;
                words[n] = '';
            }
            if(words[n] === '@'){  // 本行内有 #, 则本行格式为默认
                ctx.fillStyle = 'white';
                ctx.font = typeObj.font || "25px Arial";
                lineHeight = 25;
                words[n] = '';
            }
            const testLine = line + words[n];  //+ 长度够了，换行的逻辑
            const metrics = _ctx.measureText(testLine);  // 计算长度
            const testWidth = metrics.width;
            if (testWidth > maxWidth && n > 0) {  // 超长了
                _ctx.fillText(line, x, y);
                line = words[n];  // 另起一行
                y += lineHeight;
            } else {
                line = testLine;
            }
        }
        _ctx.fillText(line, x, y);  // 最后剩下的一行
    }
    wrapText(ctx, value, marginLeft + width * offsetX, marginTop + height * offsetY, (width - margin * 2) * (1 - offsetX - offsetXR), lineHeight);
})















































// *---[ 少用物的储物柜 ↓ ]--------------------------------------------------------------------------------------------------------------------------------------------------


// 从 COOKIE 里取出上一次的位置
var lastPos = getObjectCookie('lastPos_mvp');
if(!lastPos){
    lastPos = {x:33, y:5.00, z:498};
}
k.mainVPlayer = k.addBox({  // 创建一个立方体，并设置为主角
        name: 'mainPlayer', DPZ : 1,
        colliGroup: 1,
        isShadow: 'ok',
        // X:4.25, Y:1.00, Z:12.09,
        // X:-30.92, Y:1.00, Z:40.17,
        X:lastPos.x, Y:lastPos.y + 1, Z:lastPos.z,
        rX: 0, rY: 0, rZ: 0, size:1, mixValue:0.7,
        mass: 50,
        background : '#333',
        texture: marble
    });
k.W.next['mainPlayer'].h = 0.8;  // 防止穿模，因为纹理和地面的问题.....  后续再想好办法

k.addTABox({  // 创建一个 旋转测试 细长物理体
    DPZ : 3,
    colliGroup: 1,
    name: 'longThin', X: 29, Y: 10, Z: 496,
    mass: 1, width: 3, depth: 2, height: 2, texture: 'marble'
});

k.addTABox({  // 创建一个 旋转测试 细长物理体
    DPZ : 1,
    colliGroup: 2,
    name: 'longThin02', X: 20, Y: 10, Z: 546,
    mass: 10, width: 40, depth: 2, height: 2, background: '#333',
    texture: 'gourou',
});



// 纹理列表
const drawList = [
    {func:drawRandomNoise, id:'xnoise'},
    {func:drawjpflag, id:'jpflag', type: 'jpg'},
    // {func:drawText, id:'xjapangood', type: 'png'},
];

var groundPlanesize = 10000;

k.addBox({  // 创建地面
    DPZ : 1,
    colliGroup: 1,
    tiling : 10,
    // isShadow: 1,
    name: 'groundPlane', X: 0, Y: -0.5, Z: 0,
    mass: 0, width: groundPlanesize, depth: groundPlanesize, height: 2,
    texture: marble, background: '#287A17', mixValue: 0.5,
});

k.addBox({  // 创建一个参考1米的使用的辅助图片。它会拉低渲染，所以要记得删去
    DPZ : 1,
    colliGroup: 1,
    tiling : 10000,
    isShadow: 1,
    shape: 'plane',
    isPhysical: false,
    name: 'groundPlaneAux', X: 0, Y: 0.6, Z: 0, rX: -90,
    mass: 0, width: groundPlanesize, depth: 0, height: groundPlanesize,
    texture: marble, background: '#171f7a14', mixValue: 0.71,
});


// 日本国旗
function drawjpflag(ctx, w, h) {
    ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h);
    const radius = 150;
    ctx.beginPath();
    ctx.arc(w / 2, h / 2, radius, 0, Math.PI * 2);
    ctx.fillStyle = 'red';
    ctx.fill();
    ctx.stroke();
}


// 随机噪音
function drawRandomNoise(ctx, w, h) {
    ctx.fillStyle = '#8B8B83'; ctx.fillRect(0, 0, w, h);
    for(let i = 0; i < 50; i++) {
        const x = Math.random()*w, y = Math.random()*h;
        const s = Math.random()*30, c = `rgba(10,0,10,${Math.random()*0.3})`;
        ctx.fillStyle = c; ctx.beginPath();
        ctx.arc(x, y, s, 0, Math.PI*2); ctx.fill();
    }
}


// 一个能跑起来的计算角度的函数，凑合用吧
function calculateNorthAngle(t,a,h){var t=-t*Math.PI/180,a=-a*Math.PI/180,h=h*Math.PI/180,M=Math.cos(t),
    t=Math.sin(t),o=Math.cos(a),a=Math.sin(a),h=(Math.cos(h),Math.sin(h),a*M),a=-t,t=o*M,o=[0,0,1],M=t,
    a=Math.sqrt(Math.pow(h,2)+Math.pow(a,2)+Math.pow(t,2));let n=Math.acos(Math.min(1,Math.max(-1,M/a)));
    return n=(n=h*o[2]-t*o[0]<0?-n:n)>-Math.PI/2&&n<Math.PI/2?2*Math.PI-n:n}

// 是否使用小范围地图 10 倍？？
const isMapLittle = true;

// 绘制小地图
const mapUpdatax = setInterval(() => { drawRedDot(posMap); }, 50);
function drawRedDot(t){var l=t.getContext("2d"),e=t.width/2,i=t.height/2,a=k.mainVPlayer.X/5e3*e,r=k.mainVPlayer.Z/5e3*i,
    h=(l.clearRect(0,0,t.width,t.height),t.width/10);
    
    if(isMapLittle){
        a=k.mainVPlayer.X/5e2*e,r=k.mainVPlayer.Z/5e2*i
    }
    
    l.fillStyle="#fff",l.fillRect(0,0,t.width,t.height),l.fillStyle="#F5F7FF";
    for(let e=0;e<10;e++)for(let t=0;t<10;t++)(e+t)%2==0&&l.fillRect(e*h,t*h,h,h);t=e+a,a=i+r,l.beginPath(),l.arc(e,i,2,0,2*Math.PI),
    l.arc(t,a,1,0,2*Math.PI),l.fillStyle="red",l.fill(),l.strokeStyle="#9AFF4D",l.lineWidth=1,l.beginPath(),l.moveTo(t,a),
    r=k.W.current.mainPlayer,e=calculateNorthAngle(r.rx,r.ry,r.rz);l.lineTo(t-100*Math.sin(e),a-100*Math.cos(e)),l.stroke()}

window.k = k;
window.list = list;


// 前进
xforward.addEventListener('mousedown', function(event) {
    if(k.keys.viewForward === 1){
        k.keys.viewForward = 0;
    } else {
        k.keys.viewForward = 1;
    }
});

// 后退
xbackward.addEventListener('mousedown', function(event) {
    k.mainVPlayer.body.position.x = 113;
    k.mainVPlayer.body.position.y = 5;
    k.mainVPlayer.body.position.z = 495;
});


// 左转
xleft.addEventListener('mousedown', function(event) {
    k.antiDizzyMode = !k.antiDizzyMode;
});


// 右转
xright.addEventListener('mousedown', function(event) {
    k.mainVPlayer.body.position.x = 7.6;
    k.mainVPlayer.body.position.y = 5;
    k.mainVPlayer.body.position.z = 16.5;
});


// 蹦
xjump.addEventListener('mousedown', function(event) {
    k.mainVPlayer.body.velocity.y = 10;
});

// 开关阴影
xShadow.addEventListener('mousedown', function(event) {
    k.W.isOpenShadow = !k.W.isOpenShadow
});

k.viewType = 0;  // 0 是第三视角，1 是第一视角
// 第一视角
xVIEW1.addEventListener('mousedown', function(event) {
    k.mainCamera.pos = {x:0, y:1, z:0}
    k.viewType = 1;
});

// 第三视角
xVIEW2.addEventListener('mousedown', function(event) {
    // k.mainCamera.pos = {x: 0, y: 2, z: 4}
    // k.viewType = 0;
});


// 数字转汉字
function convertFiveDigitNumberToCommonChars(inputNumber) {
    const COMMON_CHARS = "的一是在不了有和人这中大为上个国我以要他时来用们生到作地于出就分对成会可主发年动同工也能下过子说产种面而方后多定行学法所民得经十三之进着等部度家电力里如水化高自二理起小物现实加量都两体制机当使点从业本去把性好应开它合还因由其些然前外天政四日那社义事平形相全表间样与关各重新线内数正心反你明看原又么利比或但质气第向道命此变条只没结解问意建月公无系军很情者最立代想已通并提直题党程展五果料象员革位入常文总次品式活设及管特件长求老头基资边流路级少图山统接知较将组见计别她手角期根论运农指几九区强放决西被干做必战先回すあいうえお";
    const rangeSize = COMMON_CHARS.length;
    const num = parseInt(inputNumber, 10);
    if (isNaN(num) || num < 0 || num > 99999) {
        return "输入无效：请输入一个0到99999之间的五位数字。";
    }
    const index1 = num % rangeSize;
    const scrambledNum = (num * 127 + 89);
    const index2 = scrambledNum % rangeSize;
    const char1 = COMMON_CHARS[index1];
    const char2 = COMMON_CHARS[index2];
    return char1 + char2;
}


// 一秒执行一次
setInterval(() => {
    // cookie 储存位置
    const mainVPlayerBodyPos = k.mainVPlayer.body.position;  //+2 储存主角的位置到 COOKIE
    setObjectCookie('lastPos_mvp', {x: mainVPlayerBodyPos.x, y: mainVPlayerBodyPos.y, z: mainVPlayerBodyPos.z}); // 存储对象到Cookie

    // xVIEW2.innerHTML = k.calCityName(); // 获取当前城市名称
}, 1000)

// 存储对象到Cookie
function setObjectCookie(name, obj, days) {
  const value = encodeURIComponent(JSON.stringify(obj));
  let expires = "";
  if (days) {
    const date = new Date();
    date.setTime(date.getTime() + (days*24*60*60*1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = `${name}=${value}${expires}; path=/`;
}

// 从 Cookie 读取对象
function getObjectCookie(name) {
  const cookieArr = document.cookie.split('; ');
  for(let i = 0; i < cookieArr.length; i++) {
    const cookiePair = cookieArr[i].split('=');
    if(name === cookiePair[0]) {
      return JSON.parse(decodeURIComponent(cookiePair[1]));
    }
  }
  return null;
}
</script>


